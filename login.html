<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Student Portal</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* Poppins font එක සහ මූලික background style එක යෙදීම */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f2f5;
        }

        /* ඉල්ලීමට අනුව Ticket එක සඳහා වන විශේෂිත Gradient style එක */
        .ticket-gradient {
            background: linear-gradient(to right, #541C1C, #6B2E2E, #874C1B);
        }
        
        /* Loading spinner style */
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <div id="app-container" class="w-full">

        <div id="loader" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="loader"></div>
        </div>

        <div id="auth-container" class="max-w-md mx-auto p-8 bg-white rounded-xl shadow-lg">
            
            <form id="signin-form" class="space-y-6">
                <h2 class="text-2xl font-bold text-center text-gray-800">Student Sign In</h2>
                <div>
                    <label for="signin-regno" class="block text-sm font-medium text-gray-700">Student Reg. No</label>
                    <input type="text" id="signin-regno" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="signin-password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="signin-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="flex items-center justify-between">
                    <a href="#" id="forgot-password-btn" class="text-sm text-indigo-600 hover:text-indigo-500">Forgot Password?</a>
                </div>
                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Sign In</button>
                <p class="text-center text-sm text-gray-600">
                    Don't have an account? <a href="#" id="show-signup" class="font-medium text-indigo-600 hover:text-indigo-500">Sign Up</a>
                </p>
            </form>

            <form id="signup-form" class="space-y-6 hidden">
                <h2 class="text-2xl font-bold text-center text-gray-800">Student Sign Up</h2>
                <div>
                    <label for="signup-regno" class="block text-sm font-medium text-gray-700">Student Reg. No</label>
                    <input type="text" id="signup-regno" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="signup-email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="signup-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="signup-password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="signup-password" required minlength="6" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Sign Up</button>
                <p class="text-center text-sm text-gray-600">
                    Already have an account? <a href="#" id="show-signin" class="font-medium text-indigo-600 hover:text-indigo-500">Sign In</a>
                </p>
            </form>

        </div>

        <div id="dashboard-container" class="max-w-2xl mx-auto p-8 bg-white rounded-xl shadow-lg hidden">
            <div class="flex justify-between items-start">
                <h2 class="text-3xl font-bold text-gray-800">Student Dashboard</h2>
                <button id="logout-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Logout</button>
            </div>
            <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                <div class="space-y-4">
                    <div>
                        <p class="text-sm text-gray-500">Full Name</p>
                        <p id="student-name" class="text-xl font-semibold text-gray-900">Loading...</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Registration No.</p>
                        <p id="student-regno" class="text-xl font-semibold text-gray-900">Loading...</p>
                    </div>
                </div>
                <div class="flex flex-col items-center justify-center space-y-4">
                    <img id="student-dp" src="https://via.placeholder.com/150" alt="Student DP" class="w-40 h-40 rounded-full object-cover border-4 border-gray-200">
                    <a id="download-dp-btn" href="#" download class="w-full text-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700">Download DP</a>
                </div>
            </div>
        </div>

    </div>

    <div id="ticket-for-capture" class="ticket-gradient text-white p-6 rounded-lg shadow-xl" style="width: 400px; position: absolute; top: -9999px; left: -9999px;">
        <div class="text-center border-b-2 border-dashed border-white pb-4 mb-4">
            <h3 class="text-2xl font-bold tracking-wider">EVENT TICKET</h3>
        </div>
        <div class="space-y-2">
            <div>
                <p class="text-xs uppercase opacity-75">Student Name</p>
                <p id="ticket-name" class="text-lg font-medium">Student Name</p>
            </div>
            <div>
                <p class="text-xs uppercase opacity-75">Registration No.</p>
                <p id="ticket-regno" class="text-lg font-medium">REG/000/000</p>
            </div>
        </div>
        <div class="text-center mt-6">
             <p class="text-sm font-mono">PORTAL ACCESS GRANTED</p>
        </div>
    </div>


    <script type="module">
        // Firebase SDKs 가져오기
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut,
            sendPasswordResetEmail
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            query, 
            where, 
            getDocs, 
            doc, 
            setDoc,
            getDoc
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { 
            getStorage, 
            ref, 
            getDownloadURL 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // =================================================================================
        // CONFIGURATION - මෙතන ඔබේ අගයන් යොදන්න
        // =================================================================================
        
        // TODO: FIREBASE CONFIG
        // ඔබේ Firebase ව්‍යාපෘතියෙන් ලබාගත් config අගයන් මෙතන යොදන්න
        const firebaseConfig = {
            apiKey: "AIzaSy...YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        
        // Firestore හි data ගබඩා කරන path එක සඳහා අනන්‍ය ID එකක්
        const appId = "university-portal-app"; // උදා: "university-portal"

        // Ticket එක යැවීම සඳහා ඔබ සෑදූ Google Apps Script URL එක
        const googleAppsScriptUrl = "YOUR_GOOGLE_APPS_SCRIPT_URL";

        // =================================================================================
        // FIREBASE INITIALIZATION - Firebase ආරම්භක සැකසුම්
        // =================================================================================
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // =================================================================================
        // DOM ELEMENT REFERENCES - HTML elements වෙත යොමුවීම්
        // =================================================================================
        const loader = document.getElementById('loader');
        const authContainer = document.getElementById('auth-container');
        const dashboardContainer = document.getElementById('dashboard-container');
        
        const signinForm = document.getElementById('signin-form');
        const signupForm = document.getElementById('signup-form');
        
        const showSignupLink = document.getElementById('show-signup');
        const showSigninLink = document.getElementById('show-signin');
        const forgotPasswordBtn = document.getElementById('forgot-password-btn');
        const logoutBtn = document.getElementById('logout-btn');

        // =================================================================================
        // AUTH STATE OBSERVER - පරිශීලකයා ලොග් වී ඇත්දැයි නිරීක්ෂණය කිරීම
        // =================================================================================
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // පරිශීලකයා ලොග් වී ඇත්නම්
                showLoader(true);
                authContainer.classList.add('hidden');
                dashboardContainer.classList.remove('hidden');
                fetchUserData(user); // Dashboard එක සඳහා දත්ත ලබාගැනීම
            } else {
                // පරිශීලකයා ලොග් වී නොමැතිනම්
                authContainer.classList.remove('hidden');
                dashboardContainer.classList.add('hidden');
            }
            showLoader(false);
        });

        // =================================================================================
        // UI TOGGLE FUNCTIONS - Sign In සහ Sign Up Forms මාරු කිරීම
        // =================================================================================
        showSignupLink.addEventListener('click', (e) => {
            e.preventDefault();
            signinForm.classList.add('hidden');
            signupForm.classList.remove('hidden');
        });

        showSigninLink.addEventListener('click', (e) => {
            e.preventDefault();
            signupForm.classList.add('hidden');
            signinForm.classList.remove('hidden');
        });

        // Helper function for loader
        function showLoader(show) {
            if (show) {
                loader.classList.remove('hidden');
            } else {
                loader.classList.add('hidden');
            }
        }

        // =================================================================================
        // SIGN-UP FUNCTIONALITY - නව ගිණුමක් සෑදීම
        // =================================================================================
        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoader(true);

            const regNo = document.getElementById('signup-regno').value.trim();
            const email = document.getElementById('signup-email').value.trim();
            const password = document.getElementById('signup-password').value;

            try {
                // පියවර 1: ලියාපදිංචි අංකය (Reg. No) දැනටමත් පවතීදැයි Firestore එකෙන් පරීක්ෂා කිරීම
                const usersCollectionRef = collection(db, `artifacts/${appId}/users`);
                const q = query(usersCollectionRef, where("regNo", "==", regNo));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    throw new Error(`Registration number '${regNo}' already exists.`);
                }
                
                // පියවර 2: Firebase Authentication හි නව පරිශීලකයෙක් සෑදීම
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // පියවර 3: Firestore හි පරිශීලකයාගේ profile දත්ත ගබඩා කිරීම
                // Path: artifacts/{appId}/users/{userId}/profile/data
                const userProfileRef = doc(db, `artifacts/${appId}/users/${user.uid}/profile/data`);
                await setDoc(userProfileRef, {
                    regNo: regNo,
                    email: email,
                    fullName: "Student Name" // Default නම
                });
                
                alert("Sign up successful! Please sign in.");
                signupForm.reset();
                showSigninLink.click(); // Sign in form එකට මාරු කිරීම

            } catch (error) {
                console.error("Sign up error:", error);
                alert(`Sign up failed: ${error.message}`);
            } finally {
                showLoader(false);
            }
        });

        // =================================================================================
        // SIGN-IN FUNCTIONALITY - ගිණුමට ඇතුල් වීම
        // =================================================================================
        signinForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoader(true);
            
            const regNo = document.getElementById('signin-regno').value.trim();
            const password = document.getElementById('signin-password').value;

            try {
                // පියවර 1: ලබාදුන් Reg. No එකට අදාළ email ලිපිනය Firestore එකෙන් සොයා ගැනීම
                const usersCollectionRef = collection(db, `artifacts/${appId}/users`);
                const q = query(usersCollectionRef, where("regNo", "==", regNo));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    throw new Error("No user found with this registration number.");
                }

                const userData = querySnapshot.docs[0].data();
                const userEmail = userData.email;

                // පියවර 2: සොයාගත් email ලිපිනය සහ ලබාදුන් password එක භාවිතා කර Sign In වීම
                await signInWithEmailAndPassword(auth, userEmail, password);
                // onAuthStateChanged මගින් dashboard එකට යොමු වේ

            } catch (error) {
                console.error("Sign in error:", error);
                alert(`Sign in failed: ${error.message}`);
            } finally {
                showLoader(false);
            }
        });

        // =================================================================================
        // PASSWORD RESET FUNCTIONALITY - මුරපදය අමතක වූ විට
        // =================================================================================
        forgotPasswordBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            const email = prompt("Please enter your email address to reset your password:");
            if (email) {
                showLoader(true);
                try {
                    await sendPasswordResetEmail(auth, email);
                    alert("Password reset email sent! Please check your inbox.");
                } catch (error) {
                    console.error("Password reset error:", error);
                    alert(`Error sending password reset email: ${error.message}`);
                } finally {
                    showLoader(false);
                }
            }
        });

        // =================================================================================
        // LOGOUT FUNCTIONALITY - ගිණුමෙන් ඉවත් වීම
        // =================================================================================
        logoutBtn.addEventListener('click', async () => {
            showLoader(true);
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Logout error:", error);
                alert(`Logout failed: ${error.message}`);
            }
            // onAuthStateChanged මගින් sign-in පිටුවට යොමු වේ
        });
        
        // =================================================================================
        // DASHBOARD DATA FETCHING - Dashboard එක සඳහා දත්ත ලබාගැනීම
        // =================================================================================
        async function fetchUserData(user) {
            try {
                // Firestore එකෙන් පරිශීලකයාගේ profile දත්ත ලබාගැනීම
                const userProfileRef = doc(db, `artifacts/${appId}/users/${user.uid}/profile/data`);
                const docSnap = await getDoc(userProfileRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Dashboard UI එක update කිරීම
                    document.getElementById('student-name').textContent = data.fullName;
                    document.getElementById('student-regno').textContent = data.regNo;
                    
                    // ශිෂ්‍යයාගේ DP (Display Picture) එක Storage එකෙන් ලබාගැනීම
                    fetchStudentDP(data.regNo);

                    // ස්වයංක්‍රීයව ticket එක සාදා email කිරීමේ ක්‍රියාවලිය ආරම්භ කිරීම
                    generateAndSendTicket(data, user.email);

                } else {
                    console.log("No such document!");
                    alert("Could not find user profile data.");
                    signOut(auth);
                }
            } catch (error) {
                console.error("Error fetching user data:", error);
                alert("An error occurred while fetching your data.");
            } finally {
                showLoader(false);
            }
        }
        
        // =================================================================================
        // FETCH STUDENT DP - ශිෂ්‍ය DP එක ලබාගැනීම
        // =================================================================================
        async function fetchStudentDP(regNo) {
            const dpImageElement = document.getElementById('student-dp');
            const downloadBtn = document.getElementById('download-dp-btn');
            const placeholder = 'https://via.placeholder.com/150/0000FF/FFFFFF?Text=No+DP';

            try {
                const dpPath = `student_dps/${regNo}.jpg`;
                const dpRef = ref(storage, dpPath);
                const url = await getDownloadURL(dpRef);
                
                dpImageElement.src = url;
                downloadBtn.href = url;
                downloadBtn.setAttribute('download', `${regNo}_dp.jpg`);
            } catch (error) {
                console.warn(`DP not found for ${regNo}:`, error.code);
                dpImageElement.src = placeholder;
                downloadBtn.href = '#';
                downloadBtn.style.pointerEvents = 'none';
                downloadBtn.textContent = 'DP Not Available';
                downloadBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                downloadBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
            }
        }

        // =================================================================================
        // AUTOMATED TICKET GENERATION & EMAILING - ස්වයංක්‍රීය Ticket සෑදීම සහ යැවීම
        // =================================================================================
        async function generateAndSendTicket(userData, userEmail) {
            // මෙම ක්‍රියාවලිය පසුබිමින් (background) සිදුවේ
            console.log("Starting ticket generation process...");

            const ticketElement = document.getElementById('ticket-for-capture');
            document.getElementById('ticket-name').textContent = userData.fullName;
            document.getElementById('ticket-regno').textContent = userData.regNo;

            try {
                // html2canvas භාවිතා කර hidden ticket element එක image එකක් බවට පත්කිරීම
                const canvas = await html2canvas(ticketElement, { useCORS: true });
                const base64Image = canvas.toDataURL('image/png');

                // Google Apps Script endpoint එකට දත්ත යැවීම
                const payload = {
                    email: userEmail,
                    fullName: userData.fullName,
                    ticketImage: base64Image
                };

                const response = await fetch(googleAppsScriptUrl, {
                    method: 'POST',
                    mode: 'no-cors', // Apps Script CORS ප්‍රතිපත්තිය නිසා no-cors යොදා ඇත
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                console.log('Ticket data sent to Google Apps Script successfully.');

            } catch (error) {
                console.error('Error in ticket generation/sending process:', error);
            }
        }

    </script>
</body>
</html>